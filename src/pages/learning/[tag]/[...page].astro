---
import type {GetStaticPathsOptions} from "astro";
import {TAGS} from '../../../utils/config';
const {page} = Astro.props;
const {tag} = Astro.params;
import {getCollection} from 'astro:content';
import Layout from "../../../layouts/Layout.astro";
import Pagination from "../../../components/Pagination.astro";
let allLearningPosts = (await getCollection('docs')).filter(content => content.slug.startsWith('learning'));
if (tag != 'all') allLearningPosts = allLearningPosts.filter(post => post.data.tags.includes(tag))

const allPages = [...Array(page?.lastPage ?? allLearningPosts).keys()].map((num) => {
    return `/learning/${tag}/${num === 0 ? "" : `${String(num + 1)}/`}`;
})

const learningChannels = [{
    name: '基础学习资料',
    pages: [{
        name: '基础原理和架构',
        url: ""
    }, {
        name: '应用场景',
        url: ""
    }, {
        name: '上手体验',
        url: ""
    }]
}, {
    name: '强力推荐',
    pages: [{
        name: '基础原理和架构',
        url: ""
    }, {
        name: '应用场景',
        url: ""
    }, {
        name: '上手体验',
        url: ""
    }]
}]

export async function getStaticPaths({paginate}: GetStaticPathsOptions) {
    const allLearningPosts = (await getCollection('docs')).filter(content => content.slug.startsWith('learning'));
    const allTags = ['all', ...TAGS.map(tag => tag.slug)];

    const sortedPosts = allLearningPosts.sort(
        (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf()
    );

    return allTags.flatMap((tag) => {
        const filteredPosts = sortedPosts.filter((post) =>
            tag == 'all' || post.data?.tags?.includes(tag)
        );

        return paginate(filteredPosts, {
            params: {tag},
            pageSize: 10,
        });
    });
}
---

<Layout>
    <div class="max-w-screen-xl m-auto mt-10 px-5 flex flex-row items-start gap-5">
        <div class="flex flex-col flex-grow-0 gap-5">
            <!--分类选择Tab-->
            <div class="flex flex-row gap-2">
                {
                    [{
                        name: '全部',
                        slug: 'all'
                    }, ...TAGS].map((currTag) => (
                            <a href={`/learning/${currTag.slug}`}
                               class=`${currTag.slug === tag ? 'bg-[#1e1f22]' : ''} border border-[#4a4c57] text-white text-sm font-bold py-2 px-4 rounded-full m-2`>{currTag.name}</a>
                    ))
                }
            </div>


            <div class="flex flex-row">
                <div class="flex flex-col gap-5">
                    {
                        page.data.map(post => (

                                <div class="card flex flex-row items-center gap-5 border border-[#4a4c57] hover:bg-[#1e1f22] shadow-md p-7 rounded-2xl flex-shrink-0 flex-grow-0">
                                    <img class="w-5/12 h-full object-cover rounded-lg overflow-hidden left-content"
                                         src={post.data.img} alt={post.data.title}></img>
                                    <div class="flex flex-col gap-5 text-white">
                                        <span class="text-sm">{post.data.date}</span>
                                        <a href={'/' + post.slug} class="title font-bold">{post.data.title}</a>
                                        <p class="">{post.data.description}</p>
                                        <div class="w-full flex flex-row justify-between">
                                            <span class="text-sm">作者：{post.data.author}</span>
                                            <div class="flex flex-row gap-5">
                                                {
                                                    post.data.tags.map(tag => (
                                                            <span class="text-sm">#{TAGS.find(TAG => TAG.slug == tag).name}</span>
                                                    ))
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        ))
                    }
                </div>
            </div>

            <Pagination currentPage={page.currentPage} pageSize={page.size} totalPage={page.lastPage}
                        baseUrl={`/learning/${tag}`}></Pagination>
        </div>
        <div class="flex flex-col w-5/12 px-10 items-start gap-12 mt-[35px]">
            {
                learningChannels.map(channel => (
                        <div class="w-full flex flex-col gap-5">
                            <p class="font-bold text-xl text-white">{channel.name}</p>
                            <div class="flex flex-col w-full border border-[#4a4c57] hover:bg-[#1e1f22] shadow-md px-5 py-5 gap-3 border-b rounded-2xl">
                                {
                                    channel.pages.map(page => (
                                            <a class="text-white" href={page.url}>{page.name}</a>
                                    ))
                                }
                            </div>
                        </div>
                ))
            }
        </div>
    </div>
</Layout>

<style>
    .card:hover .title {
        background: linear-gradient(134.09deg, rgba(38, 44, 244, 1) 0%, rgba(113, 64, 255, 1) 100%);
        background-clip: text;
        color: transparent;
    }
</style>
